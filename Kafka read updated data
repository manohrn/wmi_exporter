import csv
import json

def csv_to_custom_json_with_payload(csv_file_path, json_file_path):
    # Initialize a list to store all the data
    result = []

    # Open the CSV file and read its contents
    with open(csv_file_path, mode='r') as csv_file:
        csv_reader = csv.DictReader(csv_file)

        for row in csv_reader:
            # Extract server name
            server_name = row.get("server_name")

            # Create the JSON structure for each row
            entry = {
                "labels": {
                    "os": row.get("os", "linux"),  # Default to "linux" if not provided
                    "kafka_baseconfig": "id",     # Fixed field
                    "environment": row.get("env_name", "uts"),  # Taken from CSV or default
                    "kafka_exporter": "kafka_exporter"  # Fixed field
                },
                "template_variables": {
                    "kafka_monitors": []
                },
                "payload": {
                    "job_name": row.get("job_name"),
                    "target_name": row.get("target_name"),
                    "server_name": server_name,
                    "env_name": row.get("env_name"),
                    "fqdn_name": row.get("fqdn_name"),
                    "component_name": row.get("component_name"),
                    "component_id": int(row.get("component_id", 0)),  # Ensure component_id is an integer
                    "dc": row.get("dc")
                }
            }

            # Add Kafka_connect_cluster_id to kafka_monitors if component_name is "connect"
            if row.get("component_name") == "connect":
                entry["template_variables"]["kafka_monitors"].append("Kafka_connect_cluster_id")

            # Append the entry to the result list
            result.append(entry)

    # Write the result to a JSON file
    with open(json_file_path, mode='w') as json_file:
        json.dump(result, json_file, indent=4)

    print(f"CSV data from {csv_file_path} has been converted to JSON format with payload and saved as {json_file_path}.")


# Example usage
csv_file = "input.csv"  # Input CSV file path
json_file = "output.json"  # Output JSON file path
csv_to_custom_json_with_payload(csv_file, json_file)
