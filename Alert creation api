import requests
import json
import argparse

def create_alert_rule(prometheus_url, username, password, group_name, alert_name, expr, duration, severity, summary, description):
    # Define the new alert rule
    new_rule = {
        "groups": [
            {
                "name": group_name,
                "rules": [
                    {
                        "alert": alert_name,
                        "expr": expr,
                        "for": duration,
                        "labels": {
                            "severity": severity
                        },
                        "annotations": {
                            "summary": summary,
                            "description": description
                        }
                    }
                ]
            }
        ]
    }

    # Convert the rule to JSON
    rule_json = json.dumps(new_rule)

    # Make the HTTP POST request to create the new rule
    response = requests.post(
        prometheus_url,
        headers={'Content-Type': 'application/json'},
        data=rule_json,
        auth=(username, password)  # Remove this line if authentication is not required
    )

    # Check the response
    if response.status_code == 200:
        print('Successfully created the new alert rule.')
    else:
        print(f'Failed to create the alert rule. Status code: {response.status_code}')
        print('Response:', response.text)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Create a Prometheus alert rule dynamically.')
    parser.add_argument('--prometheus-url', required=True, help='Prometheus API URL, e.g., http://localhost:9090/api/v1/rules')
    parser.add_argument('--username', required=False, help='Prometheus API username')
    parser.add_argument('--password', required=False, help='Prometheus API password')
    parser.add_argument('--group-name', required=True, help='Name of the alert group')
    parser.add_argument('--alert-name', required=True, help='Name of the alert')
    parser.add_argument('--expr', required=True, help='Prometheus expression for the alert')
    parser.add_argument('--duration', required=True, help='Duration for which the condition should hold true')
    parser.add_argument('--severity', required=True, help='Severity label for the alert')
    parser.add_argument('--summary', required=True, help='Summary for the alert annotation')
    parser.add_argument('--description', required=True, help='Description for the alert annotation')

    args = parser.parse_args()

    create_alert_rule(
        prometheus_url=args.prometheus_url,
        username=args.username,
        password=args.password,
        group_name=args.group_name,
        alert_name=args.alert_name,
        expr=args.expr,
        duration=args.duration,
        severity=args.severity,
        summary=args.summary,
        description=args.description
    )
