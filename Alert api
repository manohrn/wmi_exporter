import yaml
import argparse
import requests

# Hardcoded configuration
GRAFANA_CLOUD_URL = 'https://your-grafana-cloud-endpoint/api/v1/rules'
API_KEY = 'your_api_key'
USERNAME = 'your_username'

def create_alerting_rule(alert_name, threshold):
    group_name = 'example.rules'
    namespace = 'example-namespace'
    duration = '5m'
    metric_name = 'cpu_usage'
    operator = '>'

    rule = {
        'groups': [
            {
                'name': group_name,
                'rules': [
                    {
                        'alert': alert_name,
                        'expr': f'{metric_name}{{namespace="{namespace}"}} {operator} {threshold}',
                        'for': duration,
                        'labels': {
                            'severity': 'warning',
                            'namespace': namespace,
                        },
                        'annotations': {
                            'summary': f'High {metric_name} detected in namespace {namespace}',
                            'description': f'{metric_name} in namespace {namespace} is {operator} {threshold} for more than {duration}',
                        },
                    }
                ]
            }
        ]
    }

    return yaml.dump(rule, default_flow_style=False)

def push_rule_to_grafana_cloud(rule_yaml):
    headers = {
        'Content-Type': 'application/yaml',
        'Authorization': f'Bearer {API_KEY}'
    }
    response = requests.post(GRAFANA_CLOUD_URL, headers=headers, data=rule_yaml, auth=(USERNAME, API_KEY))

    if response.status_code == 200:
        print('Alerting rule successfully pushed to Grafana Cloud')
    else:
        print(f'Failed to push alerting rule to Grafana Cloud: {response.status_code}')
        print(response.text)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Create and push a Prometheus alerting rule to Grafana Cloud')
    parser.add_argument('alert_name', type=str, help='The name of the alert')
    parser.add_argument('threshold', type=int, help='The threshold for the alert')

    args = parser.parse_args()

    # Create the alerting rule YAML
    rule_yaml = create_alerting_rule(args.alert_name, args.threshold)

    # Push the rule to Grafana Cloud
    push_rule_to_grafana_cloud(rule_yaml)
